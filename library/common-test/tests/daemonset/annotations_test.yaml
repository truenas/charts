suite: daemonset annotation test
templates:
  - common.yaml
tests:
  - it: should pass with default values
    documentIndex: &daemonsetDoc 0
    set:
      controllers:
        main:
          type: DaemonSet
    asserts:
      - hasDocuments:
          count: 3
      - isKind:
          of: DaemonSet
      - isNull:
          path: metadata.annotations
      - matchRegex:
          path: spec.template.metadata.annotations.rollme
          pattern: "^[a-zA-Z0-9]{5}$"

  - it: should pass with controller and global annotations
    documentIndex: *daemonsetDoc
    set:
      some_key: some_value
      controllers:
        main:
          type: DaemonSet
          annotations:
            controller_key: controller_value
            controller_key2: "{{ .Values.some_key }}"
      global:
        annotations:
          global_key: global_value
          global_key2: "{{ .Values.some_key }}"
    asserts:
      - equal:
          path: metadata.annotations
          value:
            controller_key: controller_value
            controller_key2: some_value
            global_key: global_value
            global_key2: some_value
      - isNull:
          path: metadata.annotations.rollme
      - matchRegex:
          path: spec.template.metadata.annotations.rollme
          pattern: "^[a-zA-Z0-9]{5}$"

  - it: should pass with podAnnotations set
    documentIndex: *daemonsetDoc
    set:
      some_key: some_value2
      controllers:
        main:
          type: DaemonSet
          pod:
            annotations:
              test: some_value
              test2: "{{ .Values.some_key }}"
    asserts:
      - isSubset:
          path: spec.template.metadata.annotations
          content:
            test2: some_value2
            test: some_value
